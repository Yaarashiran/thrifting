<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tel Aviv Map With Pins</title>
    <style>
        /* Your existing CSS styles */
    </style>
</head>
<body>
    <div id="title">Welcome to Thrifters</div>
    <div id="category-filters">
        <button onclick="filterMarkers('all')">Show All</button>
        <button onclick="toggleFavorites()">My Favorites</button>
    </div>
    <div id="favorites-list">
        <h3>My Favorites</h3>
        <ul id="favorites-ul"></ul>
    </div>
    <div id="map"></div>

    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Your existing Google Maps API script -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZ7l7sp4voo6WjVqQR5ydiP-tf7BD50OM&callback=initMap">
    </script>
    <!-- Your custom JavaScript code -->
    <script>
        // Initialize Supabase
        const supabaseUrl = 'YOUR_SUPABASE_URL'; // Replace with your Supabase Project URL
        const supabaseKey = 'YOUR_SUPABASE_KEY'; // Replace with your Supabase Public API Key
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let map;
        let markers = [];

        // Initialize the map
        function initMap() {
            const telAviv = { lat: 32.0853, lng: 34.7818 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: telAviv,
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: "poi.business",
                        stylers: [{ visibility: "off" }]
                    },
                    {
                        featureType: "poi",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Load saved markers from Supabase
            loadMarkers();

            // Add a click event listener to the map to place a marker
            map.addListener('click', function(event) {
                const description = prompt("Enter a title for this location:");
                if (description) {
                    const category = prompt("Optional: Enter a category for this location (leave blank to skip):");
                    const photoUrl = prompt("Optional: Enter a photo URL for this location (leave blank to skip):");
                    const link = prompt("Optional: Enter a website link for this location (leave blank to skip):");
                    saveMarker(event.latLng, description, category, photoUrl, link);
                }
            });
        }

        // Function to save a marker to Supabase
        async function saveMarker(location, description, category, photoUrl, link) {
            const { data, error } = await supabase
                .from('markers') // Replace with your table name
                .insert([
                    {
                        lat: location.lat(),
                        lng: location.lng(),
                        description,
                        category,
                        photo_url: photoUrl,
                        link
                    }
                ]);

            if (error) {
                console.error("Error saving marker: ", error);
            } else {
                console.log("Marker saved successfully: ", data);
                placeMarker(location, description, category, photoUrl, link);
            }
        }

        // Function to load markers from Supabase
        async function loadMarkers() {
            const { data, error } = await supabase
                .from('markers') // Replace with your table name
                .select('*');

            if (error) {
                console.error("Error loading markers: ", error);
            } else {
                data.forEach(marker => {
                    const location = { lat: marker.lat, lng: marker.lng };
                    placeMarker(location, marker.description, marker.category, marker.photo_url, marker.link);
                });
            }
        }

        // Function to place a marker on the map
        function placeMarker(location, description, category, photoUrl, link) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                title: description
            });

            let infoContent = `<strong>Description:</strong> ${description}<br>`;
            if (category) infoContent += `<strong>Category:</strong> ${category}<br>`;
            if (photoUrl) infoContent += `<img src="${photoUrl}" alt="Location Photo" style="max-width: 200px; height: auto; margin-top: 10px;"><br>`;
            if (link) infoContent += `<a href="${link}" target="_blank">Visit Website</a>`;
            infoContent += `<br><button onclick="addToFavorites('${description}')">Add to Favorites</button>`;

            const infoWindow = new google.maps.InfoWindow({ content: infoContent });

            marker.addListener('click', function() {
                infoWindow.open(map, marker);
                highlightCategory(category);
            });

            markers.push({ marker, description, category, photoUrl, link });
            updateCategoryFilters(markers);
        }

        // Function to add a marker to favorites
        function addToFavorites(description) {
            const favoritesUl = document.getElementById('favorites-ul');
            const li = document.createElement('li');
            li.textContent = description;
            favoritesUl.appendChild(li);

            const favoritesList = document.getElementById('favorites-list');
            favoritesList.style.display = 'block';

            console.log("Added to favorites:", description);
        }

        // Function to toggle the favorites list visibility
        function toggleFavorites() {
            const favoritesList = document.getElementById('favorites-list');
            if (favoritesList.style.display === 'none' || favoritesList.style.display === '') {
                favoritesList.style.display = 'block';
            } else {
                favoritesList.style.display = 'none';
            }
        }

        // Function to update category filter buttons
        function updateCategoryFilters(markers) {
            const categoryFilters = document.getElementById('category-filters');
            const categories = new Set();

            markers.forEach(marker => {
                if (marker.category) {
                    categories.add(marker.category);
                }
            });

            categoryFilters.innerHTML = '<button onclick="filterMarkers(\'all\')">Show All</button>';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.onclick = () => filterMarkers(category);
                categoryFilters.appendChild(button);
            });
        }

        // Function to filter markers by category
        function filterMarkers(category) {
            markers.forEach(marker => {
                if (category === 'all' || marker.category === category) {
                    marker.marker.setVisible(true);
                } else {
                    marker.marker.setVisible(false);
                }
            });
        }

        // Function to highlight the relevant category button
        function highlightCategory(category) {
            const buttons = document.querySelectorAll('#category-filters button');
            buttons.forEach(button => {
                if (button.textContent === category) {
                    button.classList.add('highlighted');
                } else {
                    button.classList.remove('highlighted');
                }
            });
        }
    </script>
</body>
</html>
